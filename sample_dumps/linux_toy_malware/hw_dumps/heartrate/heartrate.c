/*---------------------------------------------------------------------
----                                                               ----
---- heartrate - a heart monitoring application that calculates    ----
---- the heartrate of an individual by grabbing ECG data from an   ----
---- input text file                                               ----
----                                                               ----
---- Author(s):                                                    ----
---- - Taimour Wehbe, taimour.wehbe@gatech.edu                     ----
----                                                               ----
-----------------------------------------------------------------------
----                                                               ----
----                                                               ----
---- Hardware/Software Codesign for Security Group                 ----
---- Copyright (C) 2018 Georgia Institute of Technology            ----
----                                                               ----
----                                                               ----
---------------------------------------------------------------------*/

#include <stdio.h>
#include <time.h>

void printBeatDraw(int i);

int main(int argc, char **argv)
{
	if (argc == 2)
	{
		char *fileName = argv[1];
		FILE *file = fopen(fileName, "r");
		
		char line[32];				//line to be read from file
		double dataset = 0, oldDataset = 0;	//current and previous dataset being processed
		double ECGThreshold = 0.5;		//ECG threshold for R-peak detection
		int goingHigher = 0;			//when value changes from 1 to 0 it indicates a maximum peak has been detected
		int oldGoingHigher = 0;			//indicates if previous set of values were still increasing
		long currentTime = 0;			//current sample number (representing time)
		long peakTime = 0, oldPeakTime = 0;	//sample number where current and previous peak are found
		int heartrate = 0;			//heartrate value
		int heartBeatsNum = 0;
		
		while (fgets(line, 32, file) != NULL)	//grab line from file until EOF
		{
			sscanf(line, "%lf", &dataset);	//parse line into a double value
			currentTime++;			//increase sample number (representing time)
			//printf("Old Data: %.15f\n", oldDataset);
			//printf("Data: %.15f\n", dataset);
			
			if (dataset - oldDataset > 0)	//check if we reached a peak
				goingHigher = 1;
			else
				if (dataset - oldDataset < 0)
					goingHigher = 0;
			
			if (!goingHigher && oldGoingHigher)	//found a peak
			{
				//printf("Found a peak at sample number: %ld, Peak: %.15f\n", currentTime-1, oldDataset);
				if (oldDataset > ECGThreshold)	//check if peak is higher than R-peak threshold
				{
					peakTime = currentTime-1;	//record current peak time
					heartrate = (int) (peakTime - oldPeakTime);	//calculate heartrate
					//printf("Heartrate: %d at Peak: %.15f\n", heartrate, oldDataset);	//print heartrate
					printBeatDraw(heartBeatsNum++);
					printf("Heartrate: %.2f bpm\n\n\n\n", 60*2000/(double)heartrate);	//print heartrate
					oldPeakTime = peakTime;	//set this peak time as old peak time for next peak calculation
				}
			}
			
			oldDataset = dataset;		//set this data set as old dataset for next iteration
			oldGoingHigher = goingHigher;	//save the current state of tracking a maximum peak

			struct timespec ts;
			ts.tv_sec = 1 / 2000;
			ts.tv_nsec = 500000;
			nanosleep(&ts, NULL);
		}
	}
	else
	{
		printf("%s <input_file_name>\n", argv[0]);
		return -1;
    }
	return 0;
}

void printBeatDraw(int i)
{
	switch (i % 4) {
	case 0:
		printf("               *\n");
		printf("              * *\n");
		printf("             *   *\n");
		printf("             *   *\n");
		printf("             *   *\n");
		printf("             *   *\n");
		printf("             *   *\n");
		printf("       *     *   *          *\n");
		printf("* * * * * * *    *   * * * * * * * * * * * * * * \n");
		printf("           *      * *\n");
		printf("                   *\n");
		break;
	case 1:
		printf("                      *\n");
		printf("                     * *\n");
		printf("                    *   *\n");
		printf("                    *   *\n");
		printf("                    *   *\n");
		printf("                    *   *\n");
		printf("                    *   *\n");
		printf("              *     *   *          *\n");
		printf(" * * * * * * * * * *    *   * * * * * * * * * * *\n");
		printf("                  *      * *\n");
		printf("                          *\n");
		break;
	case 2:
		printf("                           *\n");
		printf("                          * *\n");
		printf("                         *   *\n");
		printf("                         *   *\n");
		printf("                         *   *\n");
		printf("                         *   *\n");
		printf("                         *   *\n");
		printf("                   *     *   *          *\n");
		printf("* * * * * * * * * * * * *    *   * * * * * * * * \n");
		printf("                       *      * *\n");
		printf("                               *\n");
		break;
	case 3:
		printf("                                *\n");
		printf("                               * *\n");
		printf("                              *   *\n");
		printf("                              *   *\n");
		printf("                              *   *\n");
		printf("                              *   *\n");
		printf("                              *   *\n");
		printf("                        *     *   *          *\n");
		printf(" * * * * * * * * * * * * * * *    *   * * * * * *\n");
		printf("                            *      * *\n");
		printf("                                    *\n");
		break;
	default:
		printf("You should not be here!!\n");
	}
}
